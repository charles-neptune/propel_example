REPORT zneptune_fmbb_test_ui.

*-----------------------------------------------------------------------
* Selection screen buttons
*-----------------------------------------------------------------------
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE TEXT-t01.
  SELECTION-SCREEN PUSHBUTTON /1(35) pbsubm USER-COMMAND subm.
  SELECTION-SCREEN PUSHBUTTON /1(35) pbget    USER-COMMAND getl.
SELECTION-SCREEN END OF BLOCK b1.

INITIALIZATION.
  "Maintain these in SE38 -> Text Elements -> Text Symbols
  pbsubm = TEXT-b01. " e.g. 'Create Mock Data + SUBMIT'
  pbget    = TEXT-b02. " e.g. 'Get Items Awaiting Approval'

AT SELECTION-SCREEN.
  CASE sy-ucomm.
    WHEN 'SUBM'.
      PERFORM do_submit_mock.
      sy-ucomm = 'ONLI'. "avoid re-trigger
    WHEN 'GETL'.
      PERFORM do_get_list.
      sy-ucomm = 'ONLI'.
  ENDCASE.

START-OF-SELECTION.
  "No-op: all actions are from buttons
  WRITE: / 'Use the buttons above.'.

*-----------------------------------------------------------------------
* Types for display tables
*-----------------------------------------------------------------------
  TYPES: BEGIN OF ty_hdr_list,
           sel        TYPE c LENGTH 1,          "for future checkbox selection
           refid      TYPE zfmbb_hdr-refid,
           status     TYPE zfmbb_hdr-status,
           erdat      TYPE zfmbb_hdr-erdat,
           erzet      TYPE zfmbb_hdr-erzet,
           ernam      TYPE zfmbb_hdr-ernam,
           doctype    TYPE bapi_0050_header-doctype,
           docdate    TYPE bapi_0050_header-docdate,
           pstng_date TYPE bapi_0050_header-pstng_date,
           fm_area    TYPE bapi_0050_header-fm_area,
         END OF ty_hdr_list.

  DATA gt_hdr_list TYPE STANDARD TABLE OF ty_hdr_list WITH DEFAULT KEY.
  DATA gt_return   TYPE STANDARD TABLE OF bapiret2 WITH DEFAULT KEY.

*-----------------------------------------------------------------------
* FORMS
*-----------------------------------------------------------------------
FORM do_submit_mock.

  DATA: ls_header     TYPE bapi_0050_header,
        ls_header_add TYPE bapi_0050_header_add,
        lt_item       TYPE STANDARD TABLE OF bapi_0050_item WITH DEFAULT KEY,
        lt_sender     TYPE STANDARD TABLE OF bapi_0050_item WITH DEFAULT KEY,
        lt_period     TYPE STANDARD TABLE OF bapi_0050_period WITH DEFAULT KEY,
        lt_sender_prd TYPE STANDARD TABLE OF bapi_0050_period WITH DEFAULT KEY,
        lt_longtext   TYPE STANDARD TABLE OF bapi_0050_longtext WITH DEFAULT KEY,
        lt_extin      TYPE STANDARD TABLE OF bapiparex WITH DEFAULT KEY.

  CLEAR gt_return.

  "------------------------------------------------------------
  " Build mock payload here (you already have this working)
  "------------------------------------------------------------
  PERFORM build_mock_payload
    CHANGING ls_header ls_header_add
             lt_item lt_sender
             lt_period lt_sender_prd
             lt_longtext lt_extin.

  "------------------------------------------------------------
  " Call your class SUBMIT method (stages into Z tables)
  "------------------------------------------------------------
  TRY.
      zcl_neptune_fmbb=>submit(
        EXPORTING
          i_header        = ls_header
          i_header_add    = ls_header_add
          it_item         = lt_item
          it_sender       = lt_sender
          it_period       = lt_period
          it_sender_prd   = lt_sender_prd
          it_longtext     = lt_longtext
          it_extin        = lt_extin
        IMPORTING
          et_return       = gt_return
      ).
    CATCH cx_root INTO DATA(lx).
      APPEND VALUE #( type = 'E' message = lx->get_text( ) ) TO gt_return.
  ENDTRY.

  PERFORM display_return USING 'SUBMIT RESULT' CHANGING gt_return.

ENDFORM.

FORM do_get_list.

  CLEAR: gt_hdr_list, gt_return.

  DATA lt_hdr TYPE ztt_zfmbb_hdr. "SE11 table type you created

  TRY.
      "Get headers awaiting approval (SUBMITTED)
      zcl_neptune_fmbb=>get_for_approval(
        EXPORTING
          i_status     = 'SUBMITTED'
          i_with_items = abap_false
        IMPORTING
          et_hdr       = lt_hdr
      ).
    CATCH cx_root INTO DATA(lx).
      APPEND VALUE #( type = 'E' message = lx->get_text( ) ) TO gt_return.
      PERFORM display_return USING 'GET LIST FAILED' CHANGING gt_return.
      RETURN.
  ENDTRY.

  "Project to lightweight list structure (avoid huge include display)
  LOOP AT lt_hdr ASSIGNING FIELD-SYMBOL(<h>).
    APPEND VALUE ty_hdr_list(
      refid      = <h>-refid
      status     = <h>-status
      erdat      = <h>-erdat
      erzet      = <h>-erzet
      ernam      = <h>-ernam
      doctype    = <h>-doctype
      docdate    = <h>-docdate
      pstng_date = <h>-pstng_date
      fm_area    = <h>-fm_area
    ) TO gt_hdr_list.
  ENDLOOP.

  IF gt_hdr_list IS INITIAL.
    APPEND VALUE #( type = 'I' message = 'No SUBMITTED items found.' ) TO gt_return.
    PERFORM display_return USING 'GET LIST' CHANGING gt_return.
    RETURN.
  ENDIF.

  "Show ALV list. Double-click a row to APPROVE.
  PERFORM display_hdr_list.

ENDFORM.

FORM do_approve USING i_refid TYPE zfmbb_hdr-refid.

  CLEAR gt_return.

  DATA: lv_fmarea  TYPE bapi_0050_fields-fm_area,
        lv_docyear TYPE bapi_0050_fields-doc_year,
        lv_docnum  TYPE bapi_0050_fields-document.

  TRY.
      zcl_neptune_fmbb=>approve(
        EXPORTING
          i_refid    = i_refid
        IMPORTING
          e_fmarea   = lv_fmarea
          e_docyear  = lv_docyear
          e_docnum   = lv_docnum
          et_return  = gt_return
      ).
    CATCH cx_root INTO DATA(lx).
      APPEND VALUE #( type = 'E' message = lx->get_text( ) ) TO gt_return.
  ENDTRY.

  DATA:lv_title TYPE string.
  CONCATENATE 'APPROVE' i_refid INTO lv_title SEPARATED BY space.
  PERFORM display_return USING lv_title CHANGING gt_return.

ENDFORM.

*-----------------------------------------------------------------------
* Build mock payload (stub - replace with your working mock build)
*-----------------------------------------------------------------------
FORM build_mock_payload
  CHANGING
    cs_header      TYPE bapi_0050_header
    cs_header_add  TYPE bapi_0050_header_add
    ct_item        TYPE STANDARD TABLE
    ct_sender      TYPE STANDARD TABLE
    ct_period      TYPE STANDARD TABLE
    ct_sender_prd  TYPE STANDARD TABLE
    ct_longtext    TYPE STANDARD TABLE
    ct_extin       TYPE STANDARD TABLE.

  "IMPORTANT: This is just a placeholder. Paste your working mock logic here.
  CLEAR: cs_header, cs_header_add.
  REFRESH: ct_item, ct_sender, ct_period, ct_sender_prd, ct_longtext, ct_extin.

  "Example minimal fields (youâ€™ll replace with your real working mock):
  cs_header-fm_area    = 'N100'.
  cs_header-doctype    = 'APPR'.
  cs_header-docdate    = sy-datum.
  cs_header-pstng_date = sy-datum.

  "etc...
ENDFORM.

*-----------------------------------------------------------------------
* Display: Headers list ALV (double-click approves)
*-----------------------------------------------------------------------
FORM display_hdr_list.

  DATA: lt_fcat TYPE lvc_t_fcat,
        ls_layo TYPE lvc_s_layo.

  ls_layo-zebra = abap_true.

  PERFORM build_fcat_hdr CHANGING lt_fcat.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
    EXPORTING
      i_callback_program       = sy-repid
      i_callback_user_command  = 'ALV_UCOMM'
      i_callback_pf_status_set = ''
      is_layout_lvc            = ls_layo
      it_fieldcat_lvc          = lt_fcat
      i_save                   = 'A'
    TABLES
      t_outtab                 = gt_hdr_list
    EXCEPTIONS
      program_error            = 1
      OTHERS                   = 2.

ENDFORM.

FORM build_fcat_hdr CHANGING ct_fcat TYPE lvc_t_fcat.

  DATA ls_fcat TYPE lvc_s_fcat.
  CLEAR ct_fcat.


  DEFINE add_field.
    CLEAR ls_fcat.
    ls_fcat-fieldname = &1.
    ls_fcat-coltext   = &2.
    ls_fcat-outputlen = &3.
    APPEND ls_fcat TO ct_fcat.
  END-OF-DEFINITION.

  add_field 'REFID'      'Ref ID'        30.
  add_field 'STATUS'     'Status'        10.
  add_field 'ERDAT'      'Created On'    10.
  add_field 'ERZET'      'Created At'     8.
  add_field 'ERNAM'      'Created By'    12.
  add_field 'DOCTYPE'    'DocType'        6.
  add_field 'DOCDATE'    'Doc Date'      10.
  add_field 'PSTNG_DATE' 'Posting Date'  10.
  add_field 'FM_AREA'    'FM Area'        6.

ENDFORM.

*-----------------------------------------------------------------------
* ALV user command: approve on double click
*-----------------------------------------------------------------------
FORM alv_ucomm USING r_ucomm     LIKE sy-ucomm
                     rs_selfield TYPE slis_selfield.

  CASE r_ucomm.
    WHEN '&IC1'. "double-click
      READ TABLE gt_hdr_list INDEX rs_selfield-tabindex INTO DATA(ls_row).
      IF sy-subrc = 0 AND ls_row-refid IS NOT INITIAL.
        PERFORM do_approve USING ls_row-refid.
      ENDIF.
  ENDCASE.

  rs_selfield-refresh = abap_true.

ENDFORM.

*-----------------------------------------------------------------------
* Display: Return messages as ALV (BAPIRET2)
*-----------------------------------------------------------------------
FORM display_return USING i_title TYPE string
                 CHANGING ct_ret  TYPE STANDARD TABLE of bapiret2.

  DATA lt_fcat TYPE lvc_t_fcat.

  WRITE: /.
  WRITE: / i_title.
  ULINE.

  FIELD-SYMBOLS <r> TYPE bapiret2.

  "Fallback simple list if ALV fails
  LOOP AT ct_ret ASSIGNING <r>.
    WRITE: / <r>-type, <r>-id, <r>-number, <r>-message.
  ENDLOOP.

ENDFORM.
